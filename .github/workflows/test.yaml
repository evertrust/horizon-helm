on:
  push:
    branches:
      - '**'
env:
  REGISTRY: registry.evertrust.io

jobs:
  test-install:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4


      - name: Start minikube
        uses: medyagh/setup-minikube@latest
        with:
          start-args: '--force'
          driver: 'none'

      - name: Start MongoDB
        uses: supercharge/mongodb-github-action@1.11.0

      - uses: azure/setup-helm@v4.2.0

      - name: Prepare Horizon environment
        run: |
          kubectl create namespace horizon
          kubectl create secret docker-registry evertrust-registry \
            --docker-server=${{env.REGISTRY}} \
            --docker-username="${{secrets.REPOSITORY_LOGIN}}" \
            --docker-password="${{secrets.REPOSITORY_PASSWORD}}" \
            --namespace horizon

      - name: Create license file
        run: |
          echo ${{secrets.LICENSE}} > license.lic
          kubectl create secret generic horizon-license \
            --from-file=license="license.lic" \
            --namespace horizon

      - name: Create values file
        run: |
          cat <<EOF > override-values.yaml
          image:
            pullSecrets:
              - evertrust-registry
          
          license:
            secretName: horizon-license
            secretKey: license
          
          allowedHosts:
            - localhost:9443
            - horizon:9000
          
          externalDatabase:
            uri:
              value: "mongodb://host.minikube.internal/horizon"
        
          mongodb:
            enabled: false
          EOF

      - name: Install Horizon
        continue-on-error: true
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm dependency build
          helm install --wait --timeout 60s --namespace horizon --values override-values.yaml horizon .

      - name: Create artifact with logs
        uses: actions/upload-artifact@v4
        with:
          name: logs
          path: /var/log/containers

      - name: Test Horizon
        run: |
          helm test --namespace horizon horizon

  scan-chart:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v4.2.0

      - name: Install dependencies
        run: |
          sudo apt-get install -y jq
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm dependency build

      - name: Generate YAML to scan
        run: |
          sed -z -i 's/license:\n  secretName: ""\n  secretKey: ""/license:\n  secretName: horizon-license\n  secretKey: license/' values.yaml
          sed -i 's/pullSecrets: \[\]/pullSecrets: \[ evertrust-registry \]/' values.yaml

      - name: Kubescape scan
        uses: kubescape/github-action@v3.0.5
        continue-on-error: true
        with:
          format: sarif
          outputFile: results
          severityThreshold: high
          frameworks: allcontrols


      - name: Edit results.sarif to comply with GH
        run: |
          jq '.runs[0].results |= map(.locations |= map(if .physicalLocation.region.startLine == -1 then .physicalLocation.region.startLine = 1 else . end))' results.sarif > edited.sarif

      - name: Upload Kubescape scan results to Github Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: edited.sarif



